<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposal Generator</title>
    <!-- Import CSS -->
    <link rel="stylesheet" href="proposalgenerator.css">
    <link rel="icon" type="image/png" href="for extra use.jpg" />

    <!-- PDF Libraries (Keeping these as they work fine) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- NOTE: Word Libraries (docx, FileSaver) are now imported directly inside the JS files as modules to prevent loading errors -->
</head>

<body>
    <!-- navbar -->
    <div id="nav-placeholder"></div>
    <script>
        // Function to load the navbar
        function loadNavbar() {
            fetch('navbar.html')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.text();
                })
                .then(data => {
                    document.getElementById('nav-placeholder').innerHTML = data;
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        }
        // Load the navbar when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', loadNavbar);
    </script>
    <!-- navbar end -->

    <div class="maincontainer">
        <div id="innercontainer">
            <h3 class="topHeading">Proposal Generator</h3>
            <!-- Proposal Form -->
            <form id="proposalForm">
                <div class="form-grid">

                    <div class="form-group">
                        <label for="quotation_Number">Quotation Number:</label>
                        <input type="text" id="quotation_Number" placeholder="QTN-2026-XXXX" value="QTN-2026-">
                    </div>
                    <div class="form-group">
                        <label for="client_Name">Client Name:</label>
                        <textarea type="text" id="client_Name" value="" placeholder="XYZ Pvt. Ltd."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="date">Date:</label>
                        <input type="date" id="date">
                    </div>
                    <div class="form-group">
                        <label for="special_Terms">Specific Terms:</label>
                        <textarea type="text" id="special_Terms" value=""></textarea>
                    </div>
                    <!-- water treatment type like STP/ETP -->
                    <div class="form-group">
                        <label for="treatment_Type">Water Treatment Type:</label>
                        <input type="text" id="treatment_Type" placeholder="e.g., STP/ETP" value="">
                    </div>

                    <div class="form-group">
                        <label for="module">Select Membrane Module:</label>
                        <select id="module" required>

                            <!-- BF Series -->
                            <optgroup label="BF Series">
                                <option value="BF100">BF100</option>
                                <option value="BF125">BF125</option>
                                <option value="BF200">BF200</option>
                                <option value="BF300">BF300</option>
                            </optgroup>

                            <!-- BF N Series -->
                            <optgroup label="BF N Series">
                                <option value="BF100N">BF100N</option>
                                <option value="BF150N">BF150N</option>
                                <option value="BF200N">BF200N</option>
                            </optgroup>

                            <!-- BF Oxy Series -->
                            <optgroup label="BF Oxy Series">
                                <option value="BF100oxy">BF100oxy</option>
                                <option value="BF200oxy">BF200oxy</option>
                                <option value="BF220oxy">BF220oxy</option>
                            </optgroup>

                            <!-- SUS Series -->
                            <optgroup label="SUS Series">
                                <option value="SUS097">SUS097</option>
                                <option value="SUS113">SUS113</option>
                                <option value="SUS193">SUS193</option>
                                <option value="SUS227">SUS227</option>
                                <option value="SUS313">SUS313</option>
                                <option value="SUS400">SUS400</option>
                            </optgroup>

                            <!-- 500 S Series -->
                            <optgroup label="500 Series">
                                <option value="500S">BF500S (28m2)</option>
                                <option value="500D">BF500D (31.6m2)</option>
                            </optgroup>

                        </select>

                    </div>

                    <div class="form-group">
                        <label for="flowRate">Design average daily flow rate (KLD):</label>
                        <input type="text" id="flowRate" placeholder="Enter Flow Rate" required value=""
                            oninput="this.value = this.value.replace(/[^\d.]/g, '')">
                    </div>
                    <div class="form-group">
                        <label for="flux">Design Flux (LMH):</label>
                        <input type="text" id="flux" placeholder="Enter Flux" required value=""
                            oninput="this.value = this.value.replace(/[^\d.]/g, '')">
                    </div>
                    <div class="form-group">
                        <label for="noOfTrain">Number of Skid/Train:</label>
                        <input type="text" id="noOfTrain" placeholder="Enter no of Train" required value=""
                            oninput="this.value = this.value.replace(/[^\d.]/g, '')">
                    </div>
                    <div class="form-group">
                        <label for="noOfMembraneTank">Number of Membrane Tank:</label>
                        <input type="text" id="noOfMembraneTank" placeholder="Enter no of Membrane Tank" required
                            value="" oninput="this.value = this.value.replace(/[^\d.]/g, '')">
                    </div>
                    <div class="form-group">
                        <label for="workingHr">Working Hours:</label>
                        <input type="text" id="workingHr" placeholder="Enter workingHr" value="20" required
                            oninput="this.value = this.value.replace(/[^\d.]/g, '')">
                    </div>
                    <div class="form-group">
                        <label for="membraneQty">Membrane Quantity</label>
                        <input type="number" id="membraneQty" value="">
                    </div>
                    <!-- offer price -->
                    <div class="form-group">
                        <label for="offer_Price">Offer Price (Rs. / Module):</label>
                        <input type="text" id="offer_Price" placeholder="Enter Offer Price" value="" required
                            oninput="this.value = this.value.replace(/[^\d.]/g, '')">
                    </div>
                    <!-- Authorized person who generate proposal -->
                    <div class="form-group">
                        <label for="authorized_Person">Authorized Person:</label>
                        <input type="text" id="authorized_Person" placeholder="Name Surname">
                    </div>
                </div>

                <div class="btn-container">
                    <button type="button" id="generateBtn">Generate Proposal PDF</button>
                    <button type="button" id="generateWordBtn">Generate Proposal Word</button>
                </div>
            </form>
        </div>

        <!-- Progress Modal -->
        <div id="progressModal">
            <div class="progress-modal-content">
                <h3 id="progressText">Generating Proposal...</h3>
                <div class="progress-container">
                    <div id="progressBar" class="progress-bar" style="background-color: #4CAF50;">0%</div>
                </div>
            </div>
        </div>

        <!-- SHARED UTILITIES -->
        <script>
            // --- Progress Bar Functions ---
            window.showProgressBar = function (message) {
                const modal = document.getElementById('progressModal');
                const text = document.getElementById('progressText');
                const bar = document.getElementById('progressBar');

                if (modal && text && bar) {
                    text.textContent = message || "Processing...";
                    bar.style.width = '0%';
                    bar.textContent = '0%';
                    modal.style.display = 'flex';
                }
            };

            window.updateProgressBar = async function (percent, message) {
                const text = document.getElementById('progressText');
                const bar = document.getElementById('progressBar');

                if (text && bar) {
                    if (message) text.textContent = message;
                    bar.style.width = percent + '%';
                    bar.textContent = percent + '%';
                }
                // Yield to main thread to allow UI repaint
                await new Promise(resolve => setTimeout(resolve, 10));
            };

            window.hideProgressBar = function () {
                const modal = document.getElementById('progressModal');
                if (modal) {
                    setTimeout(() => {
                        modal.style.display = 'none';
                    }, 500); // Small delay to see 100%
                }
            };

            // Function to format today's date
            function getTodayDateString() {
                const today = new Date();
                const localDate = new Date(today.getTime() - (today.getTimezoneOffset() * 60000));

                const day = String(localDate.getDate()).padStart(2, '0');
                const month = String(localDate.getMonth() + 1).padStart(2, '0'); // Months are 0-based
                const year = localDate.getFullYear();

                return `${day}-${month}-${year}`;
            }

            // Set the value of the input field
            document.getElementById('date').value = getTodayDateString();

            function loadImage(url) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.src = url;

                    img.onload = () => {
                        const canvas = document.createElement('canvas');

                        const MAX_WIDTH = 1600; // perfect for A4 print quality
                        const scale = Math.min(1, MAX_WIDTH / img.width);

                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                        // High quality JPEG (almost visually lossless)
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                        resolve(dataUrl);
                    };

                    img.onerror = () => resolve(createPlaceholderImage(200, 200, 200));
                });
            }

            // Shared function to convert base64 DataURL (from loadImage) to Uint8Array for docx
            function base64ToUint8Array(dataUrl) {
                const arr = dataUrl.split(',');
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return u8arr;
            }

            /**
             * Creates a solid color image base64 string for Model visual
             */
            function createPlaceholderImage(r, g, b) {
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 300;
                const ctx = canvas.getContext('2d');

                // Background
                ctx.fillStyle = `rgb(${r},${g},${b})`;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Text
                ctx.fillStyle = 'white';
                ctx.font = '30px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('Model Image', canvas.width / 2, canvas.height / 2);

                return canvas.toDataURL('image/jpeg');
            }

            // --- Calculation Logic (Immediate UI Feedback) ---

            // Set listeners
            const calculationInputs = ['flux', 'flowRate', 'module', 'workingHr'];
            calculationInputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.oninput = myFunction;
                    el.onchange = myFunction;
                }
            });

            // on change set the value of membraneQty into input field
            function myFunction() {
                const module = document.getElementById('module').value;
                const flowRate = parseFloat(document.getElementById('flowRate').value) || 0;
                const flux = parseFloat(document.getElementById('flux').value) || 0;
                const workingHr = document.getElementById('workingHr').value;
                let membraneSurfaceAreaPerMBR = 0;

                // Perform calculations based on formulas
                if (module == "BF100N" || module == "BF100oxy" || module == "BF100") {
                    membraneSurfaceAreaPerMBR = 10;
                } else if (module == "BF150N") {
                    membraneSurfaceAreaPerMBR = 15;
                } else if (module == "BF200N" || module == "BF200oxy" || module == "BF200") {
                    membraneSurfaceAreaPerMBR = 20;
                } else if (module == "BF125") {
                    membraneSurfaceAreaPerMBR = 12.5;
                } else if (module == "BF300") {
                    membraneSurfaceAreaPerMBR = 30;
                } else if (module == "BF220oxy") {
                    membraneSurfaceAreaPerMBR = 22;

                    // SUS series started from below
                } else if (module == "SUS097") {
                    membraneSurfaceAreaPerMBR = 9.7;
                } else if (module == "SUS113") {
                    membraneSurfaceAreaPerMBR = 11.3;
                } else if (module == "SUS193") {
                    membraneSurfaceAreaPerMBR = 19.3;
                } else if (module == "SUS227") {
                    membraneSurfaceAreaPerMBR = 22.7;
                } else if (module == "SUS313") {
                    membraneSurfaceAreaPerMBR = 31.3;
                } else if (module == "SUS400") {
                    membraneSurfaceAreaPerMBR = 40;

                    // 500 Series started from below
                } else if (module == "500S") {
                    membraneSurfaceAreaPerMBR = 28;
                } else if (module == "500D") {
                    membraneSurfaceAreaPerMBR = 31.6;
                }

                // Avoid division by zero
                if (flux > 0 && workingHr > 0 && membraneSurfaceAreaPerMBR > 0) {
                    const TotalNumberOfModule = Math.ceil((flowRate * 1000) / (flux * workingHr * membraneSurfaceAreaPerMBR));
                    document.getElementById('membraneQty').value = TotalNumberOfModule;
                } else {
                    document.getElementById('membraneQty').value = 0;
                }
            }
        </script>

        <!-- Import Separated Logic Files AS MODULES -->
        <!-- type="module" allows them to import libraries directly -->
        <script type="module" src="bf_proposal.js"></script>
        <script type="module" src="sus_proposal.js"></script>
        <script type="module" src="500s_proposal.js"></script>
        <script type="module" src="500d_proposal.js"></script>
    
        <!-- Main Click Handler -->
        <script>
            document.getElementById('generateBtn').addEventListener('click', async function () {
                const module = document.getElementById('module').value;

                // Dispatch to correct logic based on module name
                // Since files are modules, functions are attached to 'window' explicitly.
                if (module.startsWith('SUS')) {
                    if (typeof window.generateSUSProposal === 'function') {
                        await window.generateSUSProposal(this);
                    } else {
                        alert("SUS Proposal logic not loaded yet. Please wait a moment.");
                    }
                } else if (module.startsWith('BF')) {
                    // Default to BF logic for BF series
                    if (typeof window.generateBFProposal === 'function') {
                        await window.generateBFProposal(this);
                    } else {
                        alert("BF Proposal logic not loaded yet. Please wait a moment.");
                    }
                } else if (module.startsWith('500D')) {
                    if (typeof window.generate500DProposal === 'function') {
                        await window.generate500DProposal(this);
                    } else {
                        alert("BF500D Proposal logic not loaded yet. Please wait a moment.");
                    }
                } else if (module.startsWith('500S')) {
                    if (typeof window.generate500SProposal === 'function') {
                        await window.generate500SProposal(this);
                    } else {
                        alert("BF500S Proposal logic not loaded yet. Please wait a moment.");
                    }
                }
            });

            document.getElementById('generateWordBtn').addEventListener('click', async function () {
                const module = document.getElementById('module').value;

                // Dispatch to correct logic based on module name
                if (module.startsWith('SUS')) {
                    if (typeof window.generateSUSWordProposal === 'function') {
                        await window.generateSUSWordProposal(this);
                    } else {
                        alert("SUS Word Proposal logic not loaded yet. Please wait a moment.");
                    }
                } else if (module.startsWith('BF')) {
                    // Default to BF logic for BF series    
                    if (typeof window.generateBFWordProposal === 'function') {
                        await window.generateBFWordProposal(this);
                    } else {
                        alert("BF Word Proposal logic not loaded yet. Please wait a moment.");
                    }
                } else if (module.startsWith('500D')) {
                    if (typeof window.generate500DWordProposal === 'function') {
                        await window.generate500DWordProposal(this);
                    } else {
                        alert("BF500D Word Proposal logic not loaded yet. Please wait a moment.");
                    }
                } else if (module.startsWith('500S')) {
                    // Default to BF logic for BF series    
                    if (typeof window.generate500SWordProposal === 'function') {
                        await window.generate500SWordProposal(this);
                    } else {
                        alert("BF500S Word Proposal logic not loaded yet. Please wait a moment.");
                    }
                }
            });
        </script>

        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

</body>

</html>